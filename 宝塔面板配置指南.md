# 🚀 宝塔面板部署指南 - 3D 模型展示平台

## 📋 目录
1. [环境准备](#环境准备)
2. [上传项目文件](#上传项目文件)
3. [安装 Node.js 环境](#安装-nodejs-环境)
4. [创建网站配置](#创建网站配置)
5. [关键配置修改](#关键配置修改)
6. [启动 Node.js 应用](#启动-nodejs-应用)
7. [测试验证](#测试验证)
8. [常见问题](#常见问题)

---

## 环境准备

### 1️⃣ 登录宝塔面板

访问：`http://你的服务器IP:8888`

输入用户名和密码登录

### 2️⃣ 安装必要软件

在宝塔面板左侧菜单 → **软件商店**，安装以下软件：

- ✅ **Nginx 1.20+**（必须）
- ✅ **PM2 管理器**（必须，用于管理 Node.js 应用）
- ✅ **Node 版本管理器**（推荐安装 Node.js 18.x 或 20.x）

**安装步骤：**
1. 点击 "软件商店"
2. 搜索 "Nginx" → 点击 "安装"
3. 搜索 "PM2" → 点击 "安装"
4. 搜索 "Node 版本管理器" → 点击 "安装"

---

## 上传项目文件

### 方式 A：使用宝塔文件管理器上传

1. 点击左侧菜单 → **文件**
2. 进入目录：`/www/wwwroot/`
3. 点击 "上传" 按钮
4. 上传你的项目压缩包（zip 或 tar.gz）
5. 右键点击压缩包 → "解压"
6. 解压后会得到 `3dModeldisplay` 文件夹

### 方式 B：使用 Git 克隆（推荐）

1. 点击左侧菜单 → **文件**
2. 进入目录：`/www/wwwroot/`
3. 点击 "终端" 按钮
4. 执行命令：
```bash
cd /www/wwwroot/
git clone https://github.com/你的仓库地址/3dModeldisplay.git
```

### 验证项目结构

确保项目结构如下：
```
/www/wwwroot/3dModeldisplay/
├── server.js
├── package.json
├── data/
│   └── models.json
├── public/
│   ├── models/
│   ├── images/
│   ├── css/
│   └── js/
└── admin/
```

---

## 安装 Node.js 环境

### 1️⃣ 安装项目依赖

1. 点击左侧菜单 → **文件**
2. 进入 `/www/wwwroot/3dModeldisplay/`
3. 点击 "终端" 按钮
4. 执行以下命令：

```bash
# 确认当前在项目目录
pwd
# 应该显示：/www/wwwroot/3dModeldisplay

# 安装依赖
npm install

# 如果速度慢，使用国内镜像
npm install --registry=https://registry.npmmirror.com
```

### 2️⃣ 检查依赖是否安装成功

```bash
# 检查 node_modules 文件夹
ls -la
# 应该能看到 node_modules 文件夹

# 查看安装的包
npm list --depth=0
```

---

## 创建网站配置

### 1️⃣ 添加站点

1. 点击左侧菜单 → **网站**
2. 点击 "添加站点" 按钮
3. 填写表单：
   - **域名**：填写你的域名（如 `example.com`）或服务器 IP（如 `123.45.67.89`）
   - **备注**：`3D模型展示平台`
   - **根目录**：`/www/wwwroot/3dModeldisplay/public`
   - **FTP**：不创建
   - **数据库**：不创建
   - **PHP 版本**：纯静态
4. 点击 "提交"

### 2️⃣ 修改站点配置

添加完成后，在网站列表中找到刚创建的站点：

1. 点击站点名称右侧的 "设置" 按钮
2. 进入站点设置页面

---

## 关键配置修改

### 🔧 步骤 1：修改 Nginx 配置文件

在站点设置页面：

1. 点击左侧 **"配置文件"** 标签
2. 清空现有内容
3. 粘贴以下完整配置：

```nginx
server {
    listen 80;
    listen [::]:80;
    
    # 修改为你的域名或 IP
    server_name 123.45.67.89;  # ← 修改这里！
    
    # 日志文件
    access_log /www/wwwroot/3dModeldisplay/logs/access.log;
    error_log /www/wwwroot/3dModeldisplay/logs/error.log;
    
    # ========================================
    # 重要！文件上传和超时配置
    # ========================================
    
    # 允许上传大文件（支持大型 3D 模型）
    client_max_body_size 500M;
    
    # 增加超时时间
    client_body_timeout 600s;
    client_header_timeout 600s;
    send_timeout 600s;
    
    # 增加缓冲区
    client_body_buffer_size 128k;
    
    # ========================================
    # 核心配置 1：模型文件服务（支持 Range 请求）
    # ========================================
    
    location /models/ {
        # 指向实际的模型文件目录
        alias /www/wwwroot/3dModeldisplay/public/models/;
        
        # ✅ 关键！启用 Range 请求支持（渐进式加载必需）
        add_header Accept-Ranges bytes always;
        
        # ✅ CORS 跨域配置（必需）
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Range, Content-Type, Accept, Origin" always;
        add_header Access-Control-Expose-Headers "Accept-Ranges, Content-Length, Content-Range, Content-Type" always;
        
        # 处理 OPTIONS 预检请求
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Range, Content-Type, Accept, Origin" always;
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
        
        # ✅ 设置正确的 MIME 类型（重要）
        types {
            application/octet-stream    ply;     # PLY 点云
            model/obj                   obj;     # OBJ 模型
            application/octet-stream    stl;     # STL 模型
            model/gltf-binary          glb;     # GLB（预留）
            model/gltf+json            gltf;    # GLTF（预留）
        }
        default_type application/octet-stream;
        
        # 禁用 gzip（二进制文件无需压缩）
        gzip off;
        
        # 启用缓存
        expires 30d;
        add_header Cache-Control "public, immutable" always;
        
        # 性能优化
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
    }
    
    # ========================================
    # 核心配置 2：缩略图服务
    # ========================================
    
    location /images/ {
        alias /www/wwwroot/3dModeldisplay/public/images/;
        
        # CORS 配置
        add_header Access-Control-Allow-Origin * always;
        
        # 缓存配置
        expires 30d;
        add_header Cache-Control "public" always;
        
        # 图片压缩
        gzip on;
        gzip_types image/svg+xml;
    }
    
    # ========================================
    # 核心配置 3：CSS/JS 静态资源
    # ========================================
    
    location /css/ {
        alias /www/wwwroot/3dModeldisplay/public/css/;
        expires 7d;
        add_header Cache-Control "public" always;
        gzip on;
    }
    
    location /js/ {
        alias /www/wwwroot/3dModeldisplay/public/js/;
        expires 7d;
        add_header Cache-Control "public" always;
        gzip on;
        gzip_types application/javascript text/javascript;
    }
    
    # ========================================
    # 核心配置 4：管理后台（支持大文件上传）
    # ========================================
    
    location /admin/ {
        proxy_pass http://127.0.0.1:3000/admin/;
        proxy_http_version 1.1;
        
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 上传大文件超时配置
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        
        # 禁用缓冲（大文件上传必需）
        proxy_request_buffering off;
    }
    
    # ========================================
    # 核心配置 5：API 路由
    # ========================================
    
    location /api/ {
        proxy_pass http://127.0.0.1:3000/api/;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 上传超时配置
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        
        # 大文件上传
        proxy_request_buffering off;
    }
    
    # ========================================
    # 核心配置 6：默认路由（代理到 Node.js）
    # ========================================
    
    location / {
        # 代理到 Node.js 应用
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        
        # 标准代理头
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # ✅ 传递 Range 请求头（重要）
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        
        # 禁用代理缓冲
        proxy_buffering off;
        proxy_request_buffering off;
        
        # 禁用 Range 请求缓存
        proxy_no_cache $http_range $http_if_range;
        proxy_cache_bypass $http_upgrade;
        
        # 超时配置
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
    
    # ========================================
    # 错误页面
    # ========================================
    
    error_page 404 /404.html;
    error_page 502 /502.html;
}
```

4. **重要！修改第 7 行的 `server_name`**：
   - 如果有域名：改为 `server_name example.com www.example.com;`
   - 如果只有 IP：改为 `server_name 123.45.67.89;`

5. 点击 "保存" 按钮

### 🔧 步骤 2：创建日志目录

1. 点击左侧菜单 → **文件**
2. 进入 `/www/wwwroot/3dModeldisplay/`
3. 点击 "新建目录" 按钮
4. 输入目录名：`logs`
5. 点击 "确定"

### 🔧 步骤 3：设置目录权限

1. 在文件管理器中，右键点击 `3dModeldisplay` 文件夹
2. 选择 "权限"
3. 设置为 `755`
4. **勾选** "应用到子目录"
5. 点击 "确定"

或使用终端命令：
```bash
cd /www/wwwroot/
chmod -R 755 3dModeldisplay/
```

---

## 启动 Node.js 应用

### 方式 A：使用 PM2 管理器（推荐）

1. 点击左侧菜单 → **软件商店**
2. 找到 "PM2 管理器"
3. 点击 "设置"
4. 点击 "添加项目"
5. 填写表单：
   - **项目名称**：`3d-model-display`
   - **启动文件**：选择 `/www/wwwroot/3dModeldisplay/server.js`
   - **运行目录**：`/www/wwwroot/3dModeldisplay`
   - **端口**：`3000`
   - **启动命令**：默认即可
6. 点击 "提交"

### 方式 B：使用终端命令

1. 点击左侧菜单 → **文件**
2. 进入 `/www/wwwroot/3dModeldisplay/`
3. 点击 "终端"
4. 执行命令：

```bash
# 使用 PM2 启动
pm2 start server.js --name "3d-model-display"

# 设置开机自启
pm2 startup
pm2 save

# 查看运行状态
pm2 status

# 查看日志
pm2 logs 3d-model-display
```

### 验证应用启动

```bash
# 检查端口 3000 是否被监听
netstat -tlnp | grep 3000

# 应该看到类似：
# tcp6  0  0  :::3000  :::*  LISTEN  12345/node
```

---

## 测试验证

### ✅ 步骤 1：测试基本访问

打开浏览器访问：`http://你的IP或域名/`

应该能看到 3D 模型展示页面

### ✅ 步骤 2：测试管理后台

访问：`http://你的IP或域名/admin/index.html`

应该能看到管理后台界面

### ✅ 步骤 3：测试 Range 请求支持（关键！）

#### 在宝塔面板中测试

1. 点击左侧菜单 → **文件**
2. 进入 `/www/wwwroot/3dModeldisplay/public/models/`
3. 找到一个 `.ply` 文件名，例如：`modelFile-1759066178650-649551307.ply`
4. 点击左侧菜单 → **文件** → **终端**
5. 执行测试命令：

```bash
# 测试 Range 请求（替换为你的实际文件名）
curl -I -H "Range: bytes=0-1023" http://127.0.0.1/models/modelFile-你的文件名.ply

# ✅ 正确的响应应该包含：
# HTTP/1.1 206 Partial Content
# Accept-Ranges: bytes
# Content-Range: bytes 0-1023/总大小
# Access-Control-Allow-Origin: *

# ❌ 如果看到 HTTP/1.1 200 OK，说明 Range 请求未生效
```

#### 在浏览器中测试

1. 访问模型展示页面
2. 按 `F12` 打开开发者工具
3. 切换到 **Network（网络）** 标签页
4. 点击加载一个 PLY 模型
5. 在网络面板中找到 PLY 文件的请求
6. 点击该请求，查看详细信息：

**请求头（Request Headers）应该包含：**
```
Range: bytes=0-xxxxx
```

**响应头（Response Headers）应该包含：**
```
HTTP/1.1 206 Partial Content
Accept-Ranges: bytes
Content-Range: bytes 0-xxxxx/总大小
Access-Control-Allow-Origin: *
```

**状态码应该是：206（不是 200）**

### ✅ 步骤 4：测试模型上传

1. 访问管理后台：`http://你的IP/admin/index.html`
2. 点击 "上传模型" 按钮
3. 填写表单并上传一个测试模型
4. 检查是否上传成功

### ✅ 步骤 5：测试模型加载

1. 回到展示页面：`http://你的IP/`
2. 点击刚上传的模型
3. 观察加载进度：
   - ✅ 应该从 0% → 10% → 50% → 100% 逐步增加
   - ✅ 模型应该能正常显示
   - ❌ 如果卡在 0% 不动，说明 Range 请求有问题

---

## 常见问题

### 问题 1：502 Bad Gateway

**原因**：Node.js 应用未启动或端口不对

**解决方法**：
1. 检查 PM2 状态：`pm2 status`
2. 如果未运行，启动应用：`pm2 start server.js --name "3d-model-display"`
3. 查看日志：`pm2 logs`

### 问题 2：403 Forbidden

**原因**：文件权限不足

**解决方法**：
```bash
cd /www/wwwroot/
chmod -R 755 3dModeldisplay/
chown -R www:www 3dModeldisplay/
```

### 问题 3：模型加载卡在 0%

**原因**：Range 请求未正确配置

**解决方法**：
1. 检查 Nginx 配置中是否有 `add_header Accept-Ranges bytes always;`
2. 重载 Nginx 配置（宝塔面板 → 软件商店 → Nginx → 重载配置）
3. 清除浏览器缓存后重试（Ctrl+F5）

### 问题 4：上传大文件失败

**原因**：文件大小限制或超时

**解决方法**：
1. 确认 Nginx 配置中有 `client_max_body_size 500M;`
2. 检查宝塔面板 → 软件商店 → PHP（如果装了）→ 上传限制
3. 增加超时时间（已在配置中设置）

### 问题 5：CORS 错误

**原因**：跨域配置问题

**解决方法**：
确保 Nginx 配置中 `/models/` location 块包含：
```nginx
add_header Access-Control-Allow-Origin * always;
add_header Access-Control-Expose-Headers "Accept-Ranges, Content-Length, Content-Range" always;
```

### 问题 6：模型文件 404 Not Found

**原因**：路径配置错误

**解决方法**：
1. 检查文件是否存在：
```bash
ls -la /www/wwwroot/3dModeldisplay/public/models/
```
2. 确认 Nginx 配置中的 `alias` 路径正确

### 问题 7：网站无法访问

**原因**：防火墙或安全组未开放端口

**解决方法**：
1. 宝塔面板 → **安全**
2. 放行端口：`80` 和 `443`（HTTPS）
3. 如果是云服务器，还需要在云服务商控制台的安全组中放行端口

---

## 🔒 安全配置（可选但推荐）

### 1. 启用 HTTPS（免费 SSL 证书）

1. 在网站设置页面，点击 **"SSL"** 标签
2. 选择 **"Let's Encrypt"**
3. 输入你的邮箱
4. 点击 "申请"
5. 等待证书申请完成
6. 开启 "强制 HTTPS"

### 2. 设置管理后台访问密码

在 Nginx 配置中添加：
```nginx
location /admin/ {
    auth_basic "Admin Area";
    auth_basic_user_file /www/wwwroot/3dModeldisplay/.htpasswd;
    
    proxy_pass http://127.0.0.1:3000/admin/;
    # ... 其他配置 ...
}
```

然后创建密码文件：
```bash
# 安装 htpasswd 工具
yum install httpd-tools  # CentOS
apt install apache2-utils  # Ubuntu

# 创建密码文件
htpasswd -c /www/wwwroot/3dModeldisplay/.htpasswd admin
# 输入密码两次
```

### 3. 限制上传速率（防止滥用）

在 Nginx server 块中添加：
```nginx
# 限制上传速率为 10MB/s
limit_rate 10m;
```

---

## 📊 性能监控

### 使用宝塔面板监控

1. 点击左侧菜单 → **监控**
2. 查看：
   - CPU 使用率
   - 内存使用率
   - 磁盘使用情况
   - 网络流量

### 查看 PM2 进程状态

```bash
# 查看进程状态
pm2 status

# 查看详细信息
pm2 show 3d-model-display

# 查看实时日志
pm2 logs 3d-model-display --lines 100

# 查看监控
pm2 monit
```

### 查看 Nginx 日志

1. 宝塔面板 → **网站**
2. 找到你的站点，点击 "日志"
3. 查看访问日志和错误日志

或使用命令：
```bash
# 访问日志
tail -f /www/wwwroot/3dModeldisplay/logs/access.log

# 错误日志
tail -f /www/wwwroot/3dModeldisplay/logs/error.log
```

---

## ✅ 部署检查清单

完成以下所有步骤后，你的 3D 模型展示平台就部署完成了：

- [ ] 安装 Nginx、PM2、Node.js
- [ ] 上传项目文件到 `/www/wwwroot/3dModeldisplay/`
- [ ] 安装 npm 依赖（`npm install`）
- [ ] 创建网站并配置 Nginx
- [ ] 修改 `server_name` 为实际域名/IP
- [ ] 创建 `logs` 目录
- [ ] 设置目录权限（755）
- [ ] 使用 PM2 启动 Node.js 应用
- [ ] 测试基本访问（首页）
- [ ] 测试管理后台
- [ ] **测试 Range 请求（状态码 206）**
- [ ] 测试模型上传
- [ ] 测试模型加载（0% → 100%）
- [ ] （可选）配置 SSL 证书
- [ ] （可选）设置定时任务备份

---

## 🎯 关键配置总结

| 配置项 | 位置 | 作用 | 是否必需 |
|--------|------|------|---------|
| `Accept-Ranges: bytes` | `/models/` location | 启用 Range 请求 | ✅ 必需 |
| `Access-Control-Allow-Origin: *` | `/models/` location | 解决 CORS 跨域 | ✅ 必需 |
| `application/octet-stream ply` | types 配置 | PLY 文件 MIME 类型 | ✅ 必需 |
| `client_max_body_size 500M` | server 块 | 允许大文件上传 | ✅ 必需 |
| `proxy_buffering off` | proxy location | 大文件流式传输 | ✅ 必需 |
| `expires 30d` | `/models/` location | 启用缓存 | ⭐ 推荐 |
| SSL 证书 | SSL 标签页 | HTTPS 加密 | ⭐ 推荐 |

---

## 🆘 获取帮助

如果遇到问题，请提供：

1. **错误截图**（浏览器控制台 F12）
2. **Nginx 错误日志**：
   ```bash
   tail -n 50 /www/wwwroot/3dModeldisplay/logs/error.log
   ```
3. **PM2 日志**：
   ```bash
   pm2 logs 3d-model-display --lines 50
   ```
4. **curl 测试结果**：
   ```bash
   curl -I -H "Range: bytes=0-1023" http://你的IP/models/你的文件.ply
   ```

---

**祝部署成功！** 🎉

如有问题，随时联系我。

