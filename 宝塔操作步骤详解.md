# 📸 宝塔面板操作步骤详解（图文版）

> 本文档提供详细的点击路径和操作说明，适合首次使用宝塔面板的用户

---

## 第一部分：环境准备（10分钟）

### 步骤 1-1：登录宝塔面板

1. 打开浏览器
2. 输入地址：`http://你的服务器IP:8888`
   - 例如：`http://123.45.67.89:8888`
3. 输入用户名和密码
4. 点击 "登录" 按钮

💡 **提示**：如果忘记密码，SSH 登录服务器后执行 `bt default` 查看

---

### 步骤 1-2：安装 Nginx

1. 看到宝塔面板首页后，左侧菜单找到 **"软件商店"**
2. 点击 "软件商店"
3. 在顶部搜索框输入：`nginx`
4. 找到 "Nginx 1.20" 或更高版本
5. 点击右侧 **"安装"** 按钮
6. 在弹出窗口中选择 "极速安装"
7. 等待安装完成（约 2-5 分钟）
8. 安装完成后，按钮会变成 "设置"

---

### 步骤 1-3：安装 PM2 管理器

1. 仍在 "软件商店" 页面
2. 在搜索框输入：`PM2`
3. 找到 "PM2 管理器"
4. 点击 **"安装"** 按钮
5. 等待安装完成

---

### 步骤 1-4：安装 Node.js

1. 仍在 "软件商店" 页面
2. 在搜索框输入：`node`
3. 找到 "Node 版本管理器"（或 "Nodejs 版本管理器"）
4. 点击 **"安装"** 按钮
5. 安装完成后，点击 "设置"
6. 在弹出窗口中，选择安装 "v18.x" 或 "v20.x"
7. 点击 "安装" 并等待完成

---

## 第二部分：上传项目文件（5分钟）

### 步骤 2-1：进入文件管理器

1. 左侧菜单点击 **"文件"**
2. 在文件列表中，点击进入 `/www/wwwroot/` 目录
   - 你会看到路径显示：`/www/wwwroot`

---

### 步骤 2-2：上传项目压缩包（方式 A）

1. 在文件管理器页面，顶部找到 **"上传"** 按钮
2. 点击 "上传"
3. 在弹出窗口中，点击 "选择文件"
4. 选择你的项目压缩包（`3dModeldisplay.zip` 或 `.tar.gz`）
5. 等待上传完成（进度条显示 100%）
6. 上传完成后，在文件列表中找到压缩包
7. **右键点击** 压缩包文件
8. 选择 **"解压"**
9. 选择解压到当前目录
10. 点击 "确定"
11. 等待解压完成

---

### 步骤 2-3：使用 Git 克隆（方式 B，推荐）

1. 在文件管理器页面，确认当前在 `/www/wwwroot/` 目录
2. 顶部找到 **"终端"** 按钮（命令行图标）
3. 点击 "终端"
4. 在弹出的终端窗口中输入：
   ```bash
   git clone https://你的仓库地址/3dModeldisplay.git
   ```
5. 按回车键执行
6. 等待克隆完成

---

### 步骤 2-4：验证项目结构

1. 在文件列表中，应该能看到 `3dModeldisplay` 文件夹
2. 点击进入该文件夹
3. 确认包含以下文件和目录：
   - ✅ `server.js` 文件
   - ✅ `package.json` 文件
   - ✅ `data/` 文件夹
   - ✅ `public/` 文件夹
   - ✅ `admin/` 文件夹

---

## 第三部分：安装项目依赖（3分钟）

### 步骤 3-1：打开终端

1. 在文件管理器中，确认当前在 `/www/wwwroot/3dModeldisplay/` 目录
2. 点击顶部 **"终端"** 按钮
3. 终端窗口会打开，显示当前路径

---

### 步骤 3-2：安装依赖

在终端中输入以下命令：

```bash
# 确认当前位置
pwd
# 应该显示：/www/wwwroot/3dModeldisplay

# 安装依赖
npm install
```

**如果速度很慢**，使用国内镜像：
```bash
npm install --registry=https://registry.npmmirror.com
```

等待安装完成（可能需要 1-3 分钟）

---

### 步骤 3-3：验证安装

```bash
# 检查是否生成 node_modules 文件夹
ls -la

# 应该能看到：
# drwxr-xr-x  ... node_modules
```

---

## 第四部分：创建和配置网站（10分钟）

### 步骤 4-1：添加站点

1. 左侧菜单点击 **"网站"**
2. 右上角点击 **"添加站点"** 按钮
3. 在弹出窗口中填写：

**表单填写说明：**

| 字段 | 填写内容 | 说明 |
|-----|---------|------|
| **域名** | `123.45.67.89` 或 `example.com` | 填你的服务器 IP 或域名 |
| **备注** | `3D模型展示平台` | 随便填，方便识别 |
| **根目录** | `/www/wwwroot/3dModeldisplay/public` | 重要！必须是 public 目录 |
| **FTP** | 不创建 | 不勾选 |
| **数据库** | 不创建 | 不勾选 |
| **PHP版本** | 纯静态 | 选择 "纯静态" |

4. 点击 **"提交"** 按钮
5. 等待创建完成（约 3 秒）

---

### 步骤 4-2：进入网站设置

1. 在网站列表中，找到刚刚创建的站点
2. 找到站点名称右侧的 **"设置"** 按钮（齿轮图标）
3. 点击 "设置"
4. 会打开一个新页面，显示网站配置选项

---

### 步骤 4-3：修改 Nginx 配置（重要！）

1. 在网站设置页面，左侧菜单找到 **"配置文件"** 标签
2. 点击 "配置文件"
3. 会看到一个文本编辑器，里面有默认配置
4. **全选所有内容**（Ctrl+A）
5. **删除**（Delete 键）
6. **粘贴**以下完整配置：

```nginx
server {
    listen 80;
    listen [::]:80;
    
    # ⚠️ 重要！修改为你的实际 IP 或域名
    server_name 123.45.67.89;
    
    # 日志文件
    access_log /www/wwwroot/3dModeldisplay/logs/access.log;
    error_log /www/wwwroot/3dModeldisplay/logs/error.log;
    
    # 文件上传大小限制
    client_max_body_size 500M;
    client_body_timeout 600s;
    client_header_timeout 600s;
    send_timeout 600s;
    client_body_buffer_size 128k;
    
    # ========== 模型文件服务（关键配置）==========
    location /models/ {
        alias /www/wwwroot/3dModeldisplay/public/models/;
        
        # 三个核心配置（解决 PLY 加载问题）
        add_header Accept-Ranges bytes always;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Expose-Headers "Accept-Ranges, Content-Length, Content-Range, Content-Type" always;
        
        # OPTIONS 预检请求
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Range, Content-Type, Accept, Origin" always;
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
        
        # MIME 类型配置
        types {
            application/octet-stream    ply;
            model/obj                   obj;
            application/octet-stream    stl;
            model/gltf-binary          glb;
            model/gltf+json            gltf;
        }
        default_type application/octet-stream;
        
        gzip off;
        expires 30d;
        add_header Cache-Control "public, immutable" always;
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
    }
    
    # ========== 缩略图服务 ==========
    location /images/ {
        alias /www/wwwroot/3dModeldisplay/public/images/;
        add_header Access-Control-Allow-Origin * always;
        expires 30d;
        add_header Cache-Control "public" always;
        gzip on;
        gzip_types image/svg+xml;
    }
    
    # ========== CSS/JS 资源 ==========
    location /css/ {
        alias /www/wwwroot/3dModeldisplay/public/css/;
        expires 7d;
        add_header Cache-Control "public" always;
        gzip on;
    }
    
    location /js/ {
        alias /www/wwwroot/3dModeldisplay/public/js/;
        expires 7d;
        add_header Cache-Control "public" always;
        gzip on;
        gzip_types application/javascript text/javascript;
    }
    
    # ========== 管理后台 ==========
    location /admin/ {
        proxy_pass http://127.0.0.1:3000/admin/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        proxy_request_buffering off;
    }
    
    # ========== API 路由 ==========
    location /api/ {
        proxy_pass http://127.0.0.1:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        proxy_request_buffering off;
    }
    
    # ========== 默认路由 ==========
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_no_cache $http_range $http_if_range;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}
```

7. **重要！** 找到第 6 行 `server_name 123.45.67.89;`
8. 将 `123.45.67.89` 改为你的实际服务器 IP 或域名
9. 点击右上角 **"保存"** 按钮
10. 看到 "保存成功" 提示

---

### 步骤 4-4：创建日志目录

1. 左侧菜单点击 **"文件"**
2. 进入 `/www/wwwroot/3dModeldisplay/` 目录
3. 点击顶部 **"新建目录"** 按钮
4. 输入目录名：`logs`
5. 点击 "确定"

或使用终端命令：
```bash
cd /www/wwwroot/3dModeldisplay
mkdir logs
```

---

### 步骤 4-5：设置目录权限

1. 在文件管理器中，找到 `3dModeldisplay` 文件夹
2. **右键点击** 该文件夹
3. 选择 **"权限"**
4. 在弹出窗口中：
   - 设置权限为：`755`
   - **勾选** "应用到子目录"
5. 点击 "确定"

---

## 第五部分：启动 Node.js 应用（5分钟）

### 步骤 5-1：打开 PM2 管理器

1. 左侧菜单点击 **"软件商店"**
2. 在已安装软件列表中找到 **"PM2 管理器"**
3. 点击右侧 **"设置"** 按钮
4. 会打开 PM2 管理器页面

---

### 步骤 5-2：添加项目

1. 在 PM2 管理器页面，点击 **"添加项目"** 按钮
2. 在弹出窗口中填写：

| 字段 | 填写内容 |
|-----|---------|
| **项目名称** | `3d-model-display` |
| **启动文件名称** | 点击"选择文件"，找到 `/www/wwwroot/3dModeldisplay/server.js` |
| **项目路径** | `/www/wwwroot/3dModeldisplay` |
| **启动模式** | `cluster`（默认） |
| **项目端口** | `3000` |

3. 点击 **"提交"** 按钮
4. 等待启动完成（约 3 秒）
5. 在项目列表中，应该能看到：
   - 项目名：`3d-model-display`
   - 状态：绿色 `online`（在线）

---

### 步骤 5-3：设置开机自启

1. 在 PM2 项目列表中，找到 `3d-model-display`
2. 点击右侧 **"映射"** 按钮旁边的 **下拉菜单**
3. 选择 **"保存配置"**
4. 这样服务器重启后会自动启动应用

---

## 第六部分：测试验证（10分钟）

### 步骤 6-1：测试基本访问

1. 打开浏览器
2. 输入：`http://你的服务器IP/`
   - 例如：`http://123.45.67.89/`
3. **期望结果**：能看到 3D 模型展示页面

如果看到 502 错误：
- 检查 PM2 中应用状态是否为 `online`
- 如果不是，点击 "重启" 按钮

---

### 步骤 6-2：测试管理后台

1. 浏览器输入：`http://你的服务器IP/admin/index.html`
2. **期望结果**：能看到模型管理页面
3. 尝试点击 "上传模型" 按钮，看弹窗是否正常

---

### 步骤 6-3：测试 Range 请求（关键！）

**方法 A：使用终端测试**

1. 宝塔面板 → 文件 → 终端
2. 执行命令：

```bash
# 先查看有哪些模型文件
ls /www/wwwroot/3dModeldisplay/public/models/

# 选择一个 .ply 文件，复制文件名
# 执行测试（替换文件名）
curl -I -H "Range: bytes=0-1023" http://127.0.0.1/models/文件名.ply
```

3. **期望看到**：
```
HTTP/1.1 206 Partial Content
Accept-Ranges: bytes
Content-Range: bytes 0-1023/总大小
Access-Control-Allow-Origin: *
```

4. **错误情况**：
   - 如果看到 `HTTP/1.1 200 OK` → Range 请求未生效
   - 如果看到 `404 Not Found` → 文件路径错误

---

**方法 B：使用浏览器测试**

1. 访问模型展示页面
2. 按 `F12` 键打开开发者工具
3. 切换到 **Network（网络）** 标签页
4. 点击加载一个 PLY 模型
5. 在网络列表中找到 `.ply` 文件的请求
6. 点击该请求，查看详细信息

**检查点：**
- **Status Code（状态码）**：应该是 `206 Partial Content`（不是 200）
- **Response Headers（响应头）**：
  - `Accept-Ranges: bytes` ✅
  - `Content-Range: bytes 0-xxxxx/总大小` ✅
  - `Access-Control-Allow-Origin: *` ✅
- **Request Headers（请求头）**：
  - `Range: bytes=0-xxxxx` ✅

---

### 步骤 6-4：测试模型加载

1. 访问展示页面
2. 点击一个 PLY 格式的模型
3. 观察页面左下角的加载进度：
   - ✅ **正确**：`加载中: 0%` → `10%` → `50%` → `100%`，然后显示模型
   - ❌ **错误**：卡在 `加载中: 0%` 不动，控制台报错

---

## 第七部分：问题排查

### 问题 1：502 Bad Gateway

**排查步骤：**
1. PM2 管理器 → 检查应用状态
2. 如果是 `stopped`，点击 "启动"
3. 如果启动失败，点击 "日志" 查看错误信息

---

### 问题 2：403 Forbidden

**排查步骤：**
1. 文件 → 进入项目目录
2. 右键 `3dModeldisplay` → 权限
3. 设置为 `755`，应用到子目录

---

### 问题 3：模型加载卡 0%

**排查步骤：**
1. 浏览器 F12 → Console → 查看报错
2. 如果提示 `progressive loading` 错误：
   - 网站设置 → 配置文件
   - 检查 `/models/` location 中是否有：
     ```nginx
     add_header Accept-Ranges bytes always;
     ```
   - 如果没有，添加后保存
3. 清除浏览器缓存（Ctrl+Shift+Delete）
4. 刷新页面（Ctrl+F5）

---

### 问题 4：查看日志

**PM2 日志：**
- 软件商店 → PM2 管理器 → 设置
- 找到你的项目 → 点击 "日志"

**Nginx 日志：**
- 网站 → 找到你的站点 → 日志
- 查看错误日志

---

## ✅ 完成检查清单

完成以上所有步骤后，勾选以下项目：

- [ ] Nginx 已安装并运行
- [ ] PM2 已安装
- [ ] Node.js 已安装
- [ ] 项目文件已上传到 `/www/wwwroot/3dModeldisplay/`
- [ ] npm 依赖已安装（有 node_modules 文件夹）
- [ ] 网站已创建
- [ ] Nginx 配置已修改并保存
- [ ] `server_name` 已改为实际 IP/域名
- [ ] `logs` 目录已创建
- [ ] 目录权限设置为 755
- [ ] PM2 已启动应用，状态为 `online`
- [ ] 可以访问首页（http://IP/）
- [ ] 可以访问管理后台（http://IP/admin/index.html）
- [ ] curl 测试返回 `206 Partial Content`
- [ ] 浏览器 Network 显示状态码 206
- [ ] PLY 模型加载进度从 0% → 100%
- [ ] 模型能够正常显示

---

**全部勾选后，恭喜你部署成功！** 🎉

如有问题，查看《宝塔配置速查表.md》获取快速帮助。

