# 🚀 宝塔面板配置速查表 - 3D模型平台

## 📌 核心配置要点（必看！）

### ✅ 必须配置的 3 个关键点

#### 1️⃣ 启用 Range 请求支持（解决 PLY 加载 0% 问题）

在 Nginx 配置的 `/models/` location 中添加：
```nginx
add_header Accept-Ranges bytes always;
```

#### 2️⃣ 配置 CORS 跨域访问

在 Nginx 配置的 `/models/` location 中添加：
```nginx
add_header Access-Control-Allow-Origin * always;
add_header Access-Control-Expose-Headers "Accept-Ranges, Content-Length, Content-Range" always;
```

#### 3️⃣ 设置正确的 PLY 文件 MIME 类型

在 Nginx 配置的 `/models/` location 中添加：
```nginx
types {
    application/octet-stream ply;
    model/obj obj;
    application/octet-stream stl;
}
```

---

## 🎯 宝塔面板快速操作路径

### 安装软件
```
左侧菜单 → 软件商店 → 搜索 → 安装
```
需要安装：Nginx、PM2、Node版本管理器

### 上传文件
```
左侧菜单 → 文件 → /www/wwwroot/ → 上传/解压
```

### 配置网站
```
左侧菜单 → 网站 → 添加站点
根目录：/www/wwwroot/3dModeldisplay/public
```

### 修改 Nginx 配置
```
网站列表 → 设置 → 配置文件 → 粘贴完整配置 → 保存
```

### 启动 Node.js
```
软件商店 → PM2 管理器 → 设置 → 添加项目
启动文件：/www/wwwroot/3dModeldisplay/server.js
端口：3000
```

### 查看日志
```
# Nginx 日志
网站 → 日志

# PM2 日志
软件商店 → PM2 管理器 → 设置 → 查看日志
```

---

## 🔧 常用终端命令

### 进入项目目录
```bash
cd /www/wwwroot/3dModeldisplay
```

### 安装依赖
```bash
npm install
# 或使用国内镜像
npm install --registry=https://registry.npmmirror.com
```

### PM2 操作
```bash
# 启动应用
pm2 start server.js --name "3d-model-display"

# 查看状态
pm2 status

# 重启应用
pm2 restart 3d-model-display

# 停止应用
pm2 stop 3d-model-display

# 查看日志
pm2 logs 3d-model-display

# 设置开机自启
pm2 startup
pm2 save
```

### 权限设置
```bash
# 设置目录权限
chmod -R 755 /www/wwwroot/3dModeldisplay/

# 设置所有者
chown -R www:www /www/wwwroot/3dModeldisplay/
```

### 测试 Range 请求
```bash
# 替换文件名和域名
curl -I -H "Range: bytes=0-1023" http://你的IP/models/你的文件.ply

# 正确响应应该是：
# HTTP/1.1 206 Partial Content
# Accept-Ranges: bytes
```

---

## 🐛 问题诊断速查

| 问题现象 | 可能原因 | 快速解决 |
|---------|---------|---------|
| **模型加载卡 0%** | Range 请求未启用 | 检查配置中 `Accept-Ranges` |
| **502 错误** | Node.js 未启动 | `pm2 restart 3d-model-display` |
| **403 错误** | 权限不足 | `chmod -R 755 /www/wwwroot/3dModeldisplay/` |
| **404 错误** | 路径配置错误 | 检查 Nginx `alias` 路径 |
| **上传失败** | 文件大小限制 | 检查 `client_max_body_size 500M` |
| **CORS 错误** | 跨域配置缺失 | 检查 `Access-Control-Allow-Origin` |
| **状态码 200 非 206** | Range 响应头缺失 | 添加 `Accept-Ranges: bytes always` |

---

## ✅ 验证检查清单

### 配置完成后，按顺序检查：

1. **基本访问**
   ```
   访问：http://你的IP/
   期望：能看到首页
   ```

2. **管理后台**
   ```
   访问：http://你的IP/admin/index.html
   期望：能看到管理页面
   ```

3. **Range 请求（最重要！）**
   ```bash
   curl -I -H "Range: bytes=0-1023" http://你的IP/models/文件.ply
   期望：状态码 206 + Accept-Ranges: bytes
   ```

4. **浏览器测试**
   ```
   F12 → Network → 加载 PLY 模型
   期望：Status Code: 206 Partial Content
   ```

5. **模型加载**
   ```
   访问展示页面 → 点击 PLY 模型
   期望：进度从 0% → 100%，模型正常显示
   ```

---

## 📋 Nginx 配置精简版（复制粘贴用）

```nginx
server {
    listen 80;
    server_name 你的IP或域名;  # ← 改这里
    
    client_max_body_size 500M;
    client_body_timeout 600s;
    
    # 模型文件 - 核心配置
    location /models/ {
        alias /www/wwwroot/3dModeldisplay/public/models/;
        
        # 三个关键配置
        add_header Accept-Ranges bytes always;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Expose-Headers "Accept-Ranges, Content-Length, Content-Range" always;
        
        types {
            application/octet-stream ply;
            model/obj obj;
            application/octet-stream stl;
        }
        
        expires 30d;
        sendfile on;
    }
    
    # 缩略图
    location /images/ {
        alias /www/wwwroot/3dModeldisplay/public/images/;
        add_header Access-Control-Allow-Origin * always;
        expires 30d;
    }
    
    # API 路由
    location /api/ {
        proxy_pass http://127.0.0.1:3000/api/;
        proxy_request_buffering off;
        proxy_read_timeout 600s;
    }
    
    # 管理后台
    location /admin/ {
        proxy_pass http://127.0.0.1:3000/admin/;
        proxy_request_buffering off;
        proxy_read_timeout 600s;
    }
    
    # 默认路由
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Range $http_range;
        proxy_buffering off;
    }
}
```

---

## 🔑 关键路径对照表

| 用途 | 宝塔路径 |
|-----|---------|
| 项目根目录 | `/www/wwwroot/3dModeldisplay/` |
| 模型文件 | `/www/wwwroot/3dModeldisplay/public/models/` |
| 缩略图 | `/www/wwwroot/3dModeldisplay/public/images/` |
| 配置文件 | `/www/wwwroot/3dModeldisplay/data/models.json` |
| Nginx 配置 | 网站设置 → 配置文件 |
| 日志文件 | `/www/wwwroot/3dModeldisplay/logs/` |

---

## 📞 获取帮助时需要提供

1. 浏览器 F12 控制台截图
2. PM2 日志：`pm2 logs 3d-model-display --lines 50`
3. Nginx 错误日志：网站 → 日志
4. curl 测试结果（见上方命令）

---

**打印本页，部署时更方便！** 📄

